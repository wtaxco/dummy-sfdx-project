name: Build & Deploy Salesforce

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run-tests:
        description: "Run Apex tests"
        type: boolean
        default: true
        required: true

jobs:
  Push to Scratch:
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' }}
    uses: wtaxco/wtax-github-actions-workflows/.github/workflows/build-sfdx-project.yml@main
    with:
      run-tests: yes
    secrets:
      ansible-vault-password: ${{ secrets.VAULT_PASSWORD }}

  Build:
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch' }}
    uses: wtaxco/wtax-github-actions-workflows/.github/workflows/build-sfdx-artefact.yml@IN-761-Main

  Developer:
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch'  }}
    needs: Build
    uses: wtaxco/wtax-github-actions-workflows/.github/workflows/deploy-sfdx-project-to-developer.yml@IN-761-Main
    with:
      run-tests: ${{ inputs.run-tests == null || inputs.run-tests }}
      environment: developer
      metadata-zip-file: ${{ needs.Build.outputs.metadata-zip-file }}
      test-classes-file: ${{ needs.Build.outputs.test-classes-file }}
      deletes-file: ${{ needs.Build.outputs.deletes-file }}
    secrets:
      ansible-vault-password: ${{ secrets.VAULT_PASSWORD }}

  UAT:
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch'  }}
    needs: [Developer, Build]
    uses: wtaxco/wtax-github-actions-workflows/.github/workflows/deploy-sfdx-project-to-uat.yml@IN-761-Main
    with:
      run-tests: ${{ inputs.run-tests == null || inputs.run-tests }}
      environment: uat
      metadata-zip-file: ${{ needs.Build.outputs.metadata-zip-file }}
      test-classes-file: ${{ needs.Build.outputs.test-classes-file }}
      deletes-file: ${{ needs.Build.outputs.deletes-file }}
    secrets:
      ansible-vault-password: ${{ secrets.VAULT_PASSWORD }}

  Production:
    if: ${{ github.event_name == 'push' || github.event_name == 'workflow_dispatch'  }}
    needs: [UAT, Build]
    uses: wtaxco/wtax-github-actions-workflows/.github/workflows/deploy-sfdx-project-to-prod.yml@IN-761-Main
    with:
      run-tests: ${{ inputs.run-tests == null || inputs.run-tests }}
      environment: prod
      metadata-zip-file: ${{ needs.Build.outputs.metadata-zip-file }}
      test-classes-file: ${{ needs.Build.outputs.test-classes-file }}
      deletes-file: ${{ needs.Build.outputs.deletes-file }}
    secrets:
      ansible-vault-password: ${{ secrets.VAULT_PASSWORD }}
